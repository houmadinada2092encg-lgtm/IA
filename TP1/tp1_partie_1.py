# -*- coding: utf-8 -*-
"""tp1 partie 1.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1-HwfLzA6jxrHYIC16iMokUwgLw6sdrVr
"""

import numpy as np
import pandas as pd
import matplotlib.pyplot as plt
import seaborn as sns
from scipy import stats

# Configuration
sns.set_style("whitegrid")
plt.rcParams['figure.figsize'] = (14, 6)

print("="*80)
print("TP PARTIE 1 â€” STATISTIQUES ET LOI NORMALE EN FINANCE")
print("Analyse risque portefeuille et calcul VaR")
print("="*80)

# ============================================================================ # DONNÃ‰ES
# ============================================================================

# Rendements mensuels historiques (%)
rendements_A = np.array([
    1.2, 0.8, -0.5, 1.5, 0.9, 1.1, 0.7, 1.3, 1.0, 0.6, 1.4, 0.8,
    1.1, 0.9, -0.3, 1.2, 1.0, 1.5, 0.8, 1.3, 0.9, 1.1, 1.2, 1.0
])

rendements_B = np.array([
    4.5, -2.1, 6.2, -3.5, 5.8, 7.1, -1.8, 4.9, 3.2, -4.2, 8.5, -2.7,
    5.1, 6.8, -3.1, 7.3, 4.5, -2.9, 6.7, 5.3, -3.8, 7.9, 4.2, 5.5
])

# ParamÃ¨tres
capital = 500000  # â‚¬ Ã  investir
perte_max_toleree = 50000  # â‚¬ (10% capital)
taux_sans_risque = 3.0  # % annuel

# ============================================================================ # QUESTION 1.1 â€” STATISTIQUES DESCRIPTIVES
# ============================================================================

print("\n" + "="*80)
print("QUESTION 1.1 â€” STATISTIQUES DESCRIPTIVES")
print("="*80)

def calculer_stats_portefeuille(rendements, nom):
    """
    Calcule statistiques descriptives portefeuille

    Parameters:
    ----------
    rendements : np.array
        Rendements mensuels (%)
    nom : str
        Nom portefeuille

    Returns:
    -------
    dict :
        Statistiques calculÃ©es
    """
    # a) Moyenne mensuelle
    moyenne_mensuelle = np.mean(rendements)

    # b) Ã‰cart-type mensuel
    ecart_type_mensuel = np.std(rendements, ddof=1)  # ddof=1 pour Ã©chantillon

    # c) MÃ©diane
    mediane = np.median(rendements)

    # d) Rendement annualisÃ© (capitalisation composÃ©e)
    # Formule : (1 + r_mensuel/100)^12 - 1
    rendement_annuel = ((1 + moyenne_mensuelle/100)**12 - 1) * 100

    # e) VolatilitÃ© annualisÃ©e
    # Formule : Ïƒ_annuel = Ïƒ_mensuel Ã— âˆš12
    volatilite_annuelle = ecart_type_mensuel * np.sqrt(12)

    stats = {
        'nom': nom,
        'moyenne_mensuelle': moyenne_mensuelle,
        'ecart_type_mensuel': ecart_type_mensuel,
        'mediane': mediane,
        'rendement_annuel': rendement_annuel,
        'volatilite_annuelle': volatilite_annuelle
    }

    return stats

# Calcul stats pour les deux portefeuilles
stats_A = calculer_stats_portefeuille(rendements_A, "CONSERVATIVE (A)")
stats_B = calculer_stats_portefeuille(rendements_B, "AGRESSIF (B)")

# Affichage rÃ©sultats
for stats_item in [stats_A, stats_B]:
    print(f"\nðŸ“Š PORTEFEUILLE {stats_item['nom']}")
    print(f"\tâ€¢ Rendement mensuel moyen : {stats_item['moyenne_mensuelle']:.2f}%")
    print(f"\tâ€¢ Ã‰cart-type mensuel : {stats_item['ecart_type_mensuel']:.2f}%")
    print(f"\tâ€¢ MÃ©diane : {stats_item['mediane']:.2f}%")
    print(f"\tâ€¢ Rendement annualisÃ© : {stats_item['rendement_annuel']:.2f}%")
    print(f"\tâ€¢ VolatilitÃ© annualisÃ©e : {stats_item['volatilite_annuelle']:.2f}%")

# ============================================================================ # QUESTION 1.2 â€” VISUALISATION DISTRIBUTIONS
# ============================================================================

print("\n" + "="*80)
print("QUESTION 1.2 â€” VISUALISATION DISTRIBUTIONS")
print("="*80)

fig, axes = plt.subplots(1, 2, figsize=(14, 5))

# Subplot 1 : Histogrammes superposÃ©s
ax1 = axes[0]
ax1.hist(rendements_A, bins=10, alpha=0.6, color='green', edgecolor='black', label='Portefeuille A (Conservative)', density=True)
ax1.hist(rendements_B, bins=10, alpha=0.6, color='red', edgecolor='black', label='Portefeuille B (Agressif)', density=True)

# Lignes moyennes
ax1.axvline(stats_A['moyenne_mensuelle'], color='darkgreen', linestyle='--', linewidth=2, label=f'Moyenne A = {stats_A["moyenne_mensuelle"]:.2f}%')
ax1.axvline(stats_B['moyenne_mensuelle'], color='darkred', linestyle='--', linewidth=2, label=f'Moyenne B = {stats_B["moyenne_mensuelle"]:.2f}%')

ax1.set_title('Distributions rendements mensuels', fontsize=12, fontweight='bold')
ax1.set_xlabel('Rendement mensuel (%)')
ax1.set_ylabel('DensitÃ©')
ax1.legend(fontsize=9)
ax1.grid(True, alpha=0.3)

# Subplot 2 : Boxplots comparatifs
ax2 = axes[1]
data_boxplot = [rendements_A, rendements_B]
bp = ax2.boxplot(data_boxplot, tick_labels=['Portefeuille A', 'Portefeuille B'], patch_artist=True, widths=0.6)

# Couleurs boxplots
colors = ['lightgreen', 'lightcoral']
for patch, color in zip(bp['boxes'], colors):
    patch.set_facecolor(color)

ax2.set_title('Boxplots comparatifs (outliers visibles)', fontsize=12, fontweight='bold')
ax2.set_ylabel('Rendement mensuel (%)')
ax2.grid(True, alpha=0.3, axis='y')
ax2.axhline(0, color='black', linestyle=':', linewidth=1)

plt.tight_layout()
plt.show()
print("âœ“ Graphiques gÃ©nÃ©rÃ©s (histogrammes + boxplots)")

# ============================================================================ # QUESTION 1.3 â€” VALUE AT RISK (VaR 95%)
# ============================================================================

print("\n" + "="*80)
print("QUESTION 1.3 â€” VALUE AT RISK (VaR 95%)")
print("="*80)

def calculer_var_portefeuille(stats_dict, capital, alpha=0.05):
    """
    Calcule VaR paramÃ©trique mensuelle et annuelle

    Parameters:
    ----------
    stats_dict : dict
        Statistiques portefeuille (from calculer_stats_portefeuille)
    capital : float
        Capital investi (â‚¬)
    alpha : float
        Niveau risque (0.05 pour VaR 95%)

    Returns:
    -------
    dict :
        VaR calculÃ©es
    """
    # Quantile normal standard pour alpha=5% (queue gauche)
    z_alpha = stats.norm.ppf(alpha)  # â‰ˆ -1.645

    # a) VaR mensuelle (%)
    var_mensuelle_pct = stats_dict['moyenne_mensuelle'] + z_alpha * stats_dict['ecart_type_mensuel']

    # b) VaR annuelle (%)
    # MÃ©thode : Utiliser rendement et volatilitÃ© annualisÃ©s
    var_annuelle_pct = stats_dict['rendement_annuel'] + z_alpha * stats_dict['volatilite_annuelle']

    # c) VaR en perte monÃ©taire (â‚¬)
    var_mensuelle_euros = capital * (var_mensuelle_pct / 100)
    var_annuelle_euros = capital * (var_annuelle_pct / 100)

    var_results = {
        'var_mensuelle_pct': var_mensuelle_pct,
        'var_annuelle_pct': var_annuelle_pct,
        'var_mensuelle_euros': var_mensuelle_euros,
        'var_annuelle_euros': var_annuelle_euros
    }

    return var_results

# Calcul VaR pour les deux portefeuilles
var_A = calculer_var_portefeuille(stats_A, capital)
var_B = calculer_var_portefeuille(stats_B, capital)

# Affichage rÃ©sultats
print(f"\nðŸ’° CAPITAL INVESTI : â‚¬{capital:,.0f}")
print(f"ðŸš¨ PERTE MAX TOLÃ‰RÃ‰E CLIENT : â‚¬{perte_max_toleree:,.0f} (-{perte_max_toleree/capital*100:.0f}%)")
print(f"\nðŸ“‰ PORTEFEUILLE A (Conservative)")
print(f"\tâ€¢ VaR 95% mensuelle : {var_A['var_mensuelle_pct']:.2f}% â†’ â‚¬{var_A['var_mensuelle_euros']:,.0f}")
print(f"\tâ€¢ VaR 95% annuelle : {var_A['var_annuelle_pct']:.2f}% â†’ â‚¬{var_A['var_annuelle_euros']:,.0f}")
print(f"\nðŸ“‰ PORTEFEUILLE B (Agressif)")
print(f"\tâ€¢ VaR 95% mensuelle : {var_B['var_mensuelle_pct']:.2f}% â†’ â‚¬{var_B['var_mensuelle_euros']:,.0f}")
print(f"\tâ€¢ VaR 95% annuelle : {var_B['var_annuelle_pct']:.2f}% â†’ â‚¬{var_B['var_annuelle_euros']:,.0f}")

# VÃ©rification contrainte client
print(f"\nâœ… VALIDATION CONTRAINTE CLIENT (VaR annuelle â‰¤ -â‚¬50,000) :")
contrainte_A = abs(var_A['var_annuelle_euros']) <= perte_max_toleree
contrainte_B = abs(var_B['var_annuelle_euros']) <= perte_max_toleree
print(f"\tâ€¢ Portefeuille A : {'âœ“ RESPECTÃ‰E' if contrainte_A else 'âœ— NON RESPECTÃ‰E'} "
      f"({var_A['var_annuelle_euros']:,.0f} â‚¬ vs -{perte_max_toleree:,.0f} â‚¬)")
print(f"\tâ€¢ Portefeuille B : {'âœ“ RESPECTÃ‰E' if contrainte_B else 'âœ— NON RESPECTÃ‰E'} "
      f"({var_B['var_annuelle_euros']:,.0f} â‚¬ vs -{perte_max_toleree:,.0f} â‚¬)")

# d) Test normalitÃ© (Shapiro-Wilk)
print(f"\nðŸ”¬ TEST NORMALITÃ‰ (Shapiro-Wilk, H0: donnÃ©es normales)")

stat_A, p_value_A = stats.shapiro(rendements_A)
stat_B, p_value_B = stats.shapiro(rendements_B)

print(f"\n\tPORTEFEUILLE A :")
print(f"\tâ€¢ Statistique Shapiro : {stat_A:.4f}")
print(f"\tâ€¢ P-value : {p_value_A:.4f}")
if p_value_A > 0.05:
    print(f"\tâœ“ DonnÃ©es compatibles loi normale (p > 0.05)")
else:
    print(f"\tâœ— DonnÃ©es s'Ã©cartent loi normale (p < 0.05) â†’ VaR paramÃ©trique moins fiable")

print(f"\n\tPORTEFEUILLE B :")
print(f"\tâ€¢ Statistique Shapiro : {stat_B:.4f}")
print(f"\tâ€¢ P-value : {p_value_B:.4f}")
if p_value_B > 0.05:
    print(f"\tâœ“ DonnÃ©es compatibles loi normale (p > 0.05)")
else:
    print(f"\tâœ— DonnÃ©es s'Ã©cartent loi normale (p < 0.05) â†’ VaR paramÃ©trique moins fiable")

# ============================================================================ # QUESTION 1.4 â€” RATIO SHARPE ET RECOMMANDATION
# ============================================================================

print("\n" + "="*80)
print("QUESTION 1.4 â€” RATIO SHARPE ET RECOMMANDATION CLIENT")
print("="*80)

# a) Calcul Ratio Sharpe
sharpe_A = (stats_A['rendement_annuel'] - taux_sans_risque) / stats_A['volatilite_annuelle']
sharpe_B = (stats_B['rendement_annuel'] - taux_sans_risque) / stats_B['volatilite_annuelle']
print(f"\nðŸ“Š RATIO SHARPE (Rendement ajustÃ© risque)")

print(f"\tFormule : (Rendement annuel - Taux sans risque) / VolatilitÃ© annuelle")
print(f"\tTaux sans risque (rf) : {taux_sans_risque}%")

print(f"\n\tPORTEFEUILLE A :")
print(f"\tâ€¢ Sharpe = ({stats_A['rendement_annuel']:.2f} - {taux_sans_risque}) / {stats_A['volatilite_annuelle']:.2f}")
print(f"\tâ€¢ Sharpe = {sharpe_A:.3f}")

print(f"\n\tPORTEFEUILLE B :")
print(f"\tâ€¢ Sharpe = ({stats_B['rendement_annuel']:.2f} - {taux_sans_risque}) / {stats_B['volatilite_annuelle']:.2f}")
print(f"\tâ€¢ Sharpe = {sharpe_B:.3f}")

# InterprÃ©tation Sharpe
print(f"\n\tINTERPRÃ‰TATION :")
if sharpe_A > 1:
    print(f"\tâœ“ Portefeuille A : Excellent (Sharpe > 1)")
elif sharpe_A > 0.5:
    print(f"\tâœ“ Portefeuille A : Bon (0.5 < Sharpe < 1)")
else:
    print(f"\tâœ— Portefeuille A : Faible (Sharpe < 0.5)")

if sharpe_B > 1:
    print(f"\tâœ“ Portefeuille B : Excellent (Sharpe > 1)")
elif sharpe_B > 0.5:
    print(f"\tâœ“ Portefeuille B : Bon (0.5 < Sharpe < 1)")
else:
    print(f"\tâœ— Portefeuille B : Faible (Sharpe < 0.5)")

# b) RECOMMANDATION CLIENT
print(f"\n" + "="*80)
print("ðŸŽ¯ RECOMMANDATION CLIENT FINALE")
print("="*80)
print(f"\nðŸ“‹ CRITÃˆRES DÃ‰CISION :")
print(f"\t1. VaR 95% annuelle â‰¤ -â‚¬50,000 (contrainte risque)")
print(f"\t2. Ratio Sharpe maximum (efficience)")
print(f"\t3. NormalitÃ© rendements (fiabilitÃ© VaR)")
print(f"\nðŸ“Š TABLEAU COMPARATIF :")
print(f"\n{'CritÃ¨re':<30} {'Portefeuille A':<20} {'Portefeuille B':<20}")
print(f"{'-'*70}")
print(f"{('Rendement annuel'):<30} {stats_A['rendement_annuel']:>8.2f}% {stats_B['rendement_annuel']:>28.2f}%")
print(f"{('VolatilitÃ© annuelle'):<30} {stats_A['volatilite_annuelle']:>8.2f}% {stats_B['volatilite_annuelle']:>28.2f}%")
print(f"{('VaR 95% (â‚¬)'):<30} {var_A['var_annuelle_euros']:>13,.0f} â‚¬ {var_B['var_annuelle_euros']:>22,.0f} â‚¬")
print(f"{('Contrainte respectÃ©e'):<30} {'âœ“ OUI' if contrainte_A else 'âœ— NON':<20} {'âœ“ OUI' if contrainte_B else 'âœ— NON':<20}")
print(f"{('Ratio Sharpe'):<30} {sharpe_A:>13.3f} {sharpe_B:>27.3f}")
print(f"{('NormalitÃ© (p-value)'):<30} {p_value_A:>13.3f} {p_value_B:>27.3f}")
print(f"\nðŸ’¡ RECOMMANDATION FINALE :")

# Logique dÃ©cision
if not contrainte_A and not contrainte_B:
    print(f"\tâŒ AUCUN PORTEFEUILLE ne respecte contrainte risque client.")
    print(f"\tâ†’ RÃ©duire allocation ou revoir tolÃ©rance perte.")
elif contrainte_A and not contrainte_B:
    print(f"\tâœ… PORTEFEUILLE A (Conservative) RECOMMANDÃ‰")
    print(f"\tâ†’ Seul respecte VaR â‰¤ -â‚¬50,000")
    print(f"\tâ†’ Sharpe {sharpe_A:.2f} correct, volatilitÃ© maÃ®trisÃ©e {stats_A['volatilite_annuelle']:.1f}%")
elif not contrainte_A and contrainte_B:
    print(f"\tâœ… PORTEFEUILLE B (Agressif) RECOMMANDÃ‰")
    print(f"\tâ†’ Seul respecte VaR â‰¤ -â‚¬50,000")
    print(f"\tâ†’ Rendement Ã©levÃ© {stats_B['rendement_annuel']:.1f}% mais volatilitÃ© importante {stats_B['volatilite_annuelle']:.1f}%")
else:  # Les deux respectent contrainte
    if sharpe_A > sharpe_B:
        print(f"\tâœ… PORTEFEUILLE A (Conservative) RECOMMANDÃ‰")
        print(f"\tâ†’ Meilleur Sharpe ({sharpe_A:.2f} vs {sharpe_B:.2f})")
        print(f"\tâ†’ Profil risque/rendement optimal selon contrainte client")
    else:
        print(f"\tâœ… PORTEFEUILLE B (Agressif) RECOMMANDÃ‰")
        print(f"\tâ†’ Meilleur Sharpe ({sharpe_B:.2f} vs {sharpe_A:.2f})")
        print(f"\tâ†’ Rendement supÃ©rieur ({stats_B['rendement_annuel']:.1f}% vs {stats_A['rendement_annuel']:.1f}%)")

print(f"\n\tJUSTIFICATION :")
print(f"\tâ€¢ VaR paramÃ©trique fiable si normalitÃ© vÃ©rifiÃ©e (test Shapiro p > 0.05)")
print(f"\tâ€¢ Sharpe mesure efficience : unitÃ©s rendement excÃ©dentaire par unitÃ© risque")
print(f"\tâ€¢ Client conservateur â†’ PrivilÃ©gier A (stabilitÃ©)")
print(f"\tâ€¢ Client tolÃ©rant volatilitÃ© â†’ Envisager B si Sharpe meilleur et VaR OK")
print(f"\nâœ“ FIN PARTIE 1\n")